name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: ${{ matrix.os }}-${{ matrix.compiler }}-${{ matrix.arch }}-${{ matrix.build_type }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        # 只保留 build_type 作为基础维度，它会与 include 里的每一项交叉组合
        build_type: [Debug, Release]
        include:
          # --- Windows MSVC (x86, x64, ARM64) ---
          - os: windows-latest
            compiler: msvc
            arch: x64
          - os: windows-latest
            compiler: msvc
            arch: x86
          - os: windows-latest
            compiler: msvc
            arch: arm64

          # --- Windows MinGW (x86, x64) ---
          - os: windows-latest
            compiler: mingw
            arch: x64
            cc: gcc
            cxx: g++
          - os: windows-latest
            compiler: mingw
            arch: x86
            cc: gcc
            cxx: g++

          # --- Ubuntu GCC (x64, x86, ARM32, ARM64) ---
          - os: ubuntu-latest
            compiler: gcc
            arch: x64
            cc: gcc
            cxx: g++
          - os: ubuntu-latest
            compiler: gcc
            arch: x86
            cc: gcc
            cxx: g++
          - os: ubuntu-latest
            compiler: gcc
            arch: arm64
            cc: aarch64-linux-gnu-gcc
            cxx: aarch64-linux-gnu-g++
          - os: ubuntu-latest
            compiler: gcc
            arch: arm32
            cc: arm-linux-gnueabihf-gcc
            cxx: arm-linux-gnueabihf-g++

          # --- Ubuntu Clang (x64, ARM64) ---
          - os: ubuntu-latest
            compiler: clang
            arch: x64
            cc: clang
            cxx: clang++
          - os: ubuntu-latest
            compiler: clang
            arch: arm64
            cc: clang
            cxx: clang++

          # --- MacOS Apple-Clang (x64, ARM64) ---
          - os: macos-latest
            compiler: apple-clang
            arch: x64
            cc: clang
            cxx: clang++
          - os: macos-latest
            compiler: apple-clang
            arch: arm64
            cc: clang
            cxx: clang++

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Linux Multi-arch Support
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          if [ "${{ matrix.arch }}" = "x86" ]; then
            sudo apt-get install -y gcc-multilib g++-multilib
          elif [ "${{ matrix.arch }}" = "arm64" ]; then
            sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
          elif [ "${{ matrix.arch }}" = "arm32" ]; then
            sudo apt-get install -y gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf
          fi

      # --- 2. 编译器环境初始化 ---
      - name: Setup MSVC
        if: matrix.compiler == 'msvc'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.arch }}

      # --- 3. CMake 配置 ---
      - name: Configure CMake
        env:
          CC: ${{ matrix.cc }}
          CXX: ${{ matrix.cxx }}
        shell: bash
        run: |
          # 初始参数：使用 Ninja Multi-Config 提高效率
          CMAKE_ARGS="-G \"Ninja Multi-Config\""

          # Windows MSVC 架构指定
          if [ "${{ matrix.compiler }}" = "msvc" ]; then
            ARCH_ARG=$([ "${{ matrix.arch }}" = "x86" ] && echo "Win32" || echo "${{ matrix.arch }}")
            CMAKE_ARGS="$CMAKE_ARGS -A $ARCH_ARG"
          fi

          # MacOS 架构指定
          if [ "${{ runner.os }}" = "macOS" ]; then
            CMAKE_ARGS="$CMAKE_ARGS -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch == 'x64' && 'x86_64' || 'arm64' }}"
          fi

          # Linux 交叉编译基础标志
          if [ "${{ runner.os }}" = "Linux" ] && [ "${{ matrix.arch }}" != "x64" ] && [ "${{ matrix.arch }}" != "x86" ]; then
            CMAKE_ARGS="$CMAKE_ARGS -DCMAKE_SYSTEM_NAME=Linux -DCMAKE_SYSTEM_PROCESSOR=${{ matrix.arch }}"
          fi

          eval cmake -S . -B build $CMAKE_ARGS

      # --- 4. 构建 ---
      - name: Build
        run: |
          cmake --build build --config ${{ matrix.build_type }}

      # --- 5. 运行测试 ---
      - name: Run Tests
        shell: bash
        run: |
          # 仅在宿主机架构匹配时运行测试（交叉编译无法直接运行）
          RUN_TEST=true
          if [ "${{ matrix.arch }}" = "arm64" ] || [ "${{ matrix.arch }}" = "arm32" ]; then
             if [ "${{ runner.arch }}" != "ARM64" ]; then RUN_TEST=false; fi
          fi
          if [ "${{ matrix.arch }}" = "x86" ] && [ "${{ runner.os }}" = "Windows" ]; then RUN_TEST=true; fi

          if [ "$RUN_TEST" = true ]; then
            cd build
            ctest -C ${{ matrix.build_type }} --output-on-failure
          else
            echo "Skipping tests: Cross-compiled architecture cannot run on this runner."
          fi